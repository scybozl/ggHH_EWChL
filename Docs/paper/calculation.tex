The calculation builds on the one presented in Ref.~\cite{Heinrich:2017kxx} and therefore will be described only briefly here. 

The leading order amplitude in the full theory and  all the
amplitudes in the $m_t\to\infty$ limit were implemented analytically, whereas the
one-loop real radiation contribution and the two-loop virtual
amplitudes in the full SM rely on numerical or semi-numerical
codes.
The real radiation matrix elements in the full SM were implemented
using the interface~\cite{Luisoni:2013cuh}
between \gosam~\cite{Cullen:2011ac,Cullen:2014yla} and
the \powhegbox~\cite{Nason:2004rx,Frixione:2007vw,Alioli:2010xd}, modified
accordingly to compute the real corrections to the loop-induced Born amplitude. 
%The one-loop real amplitudes we generated with the version 2.0 of \gosam{}~\cite{Cullen:2014yla}, 
%which uses {\tt Qgraf}~\cite{Nogueira:1991ex}, \form~\cite{Kuipers:2012rf} and
%{\tt spinney}~\cite{Cullen:2010jv} for the generation of the Feynman
%diagrams, and offers a choice from {\tt Samurai}~\cite{Mastrolia:2010nb,vanDeurzen:2013pja}, {\tt golem95C}~\cite{Binoth:2008uq,Cullen:2011kv,Guillet:2013msa}
%and \ninja{}~\cite{Peraro:2014cba} for the
%reduction. 
 At run time the amplitudes were computed using
\ninja{}~\cite{Peraro:2014cba},  {\tt golem95C}~\cite{Binoth:2008uq,Cullen:2011kv} and \avholo{}~\cite{vanHameren:2010cp}
for the evaluation of the scalar one-loop integrals.
The stability of the amplitudes in the collinear limits has been improved by a better detection of instabilities in the real radiation 
and the use of the scalar four-point function from {\tt VBFNLO}~\cite{Arnold:2008rz,Baglio:2014uba}.

For the virtual corrections, containing two-loop amplitudes, we have used the results of the
calculation presented in Refs.~\cite{Borowka:2016ehy,Borowka:2016ypz},
which used also {\sc Reduze}\,2~\cite{vonManteuffel:2012np} and {\sc
 SecDec}\,3~\cite{Borowka:2015mxa}.

The values for the Higgs boson and top quark masses have been set to
$m_h=125$\,GeV and $m_t=173$\,GeV, such that the two-loop amplitudes
are only functions of two independent variables, the parton-level Mandelstam invariants
$\hat{s}$ and $\hat{t}$.  We have constructed a grid in these
variables together with an interpolation framework, such that an
external program can call the virtual two-loop amplitude at any phase space
point without having to do costly two-loop integrations.
We used the same setup for the grid as described in Ref.~\cite{Heinrich:2017kxx} and extended it in the following way:
We can write the squared matrix element as a polynomial of degree two in $\lambda$, 
\begin{align}
M_\lambda& \equiv |{\cal M}_\lambda|^2=A+B\,\lambda + C\,\lambda^2\;. \label{eq-amplambdadep}
\end{align}
Therefore it is sufficient to know the amplitude at three different values of $\lambda$ in order to reconstruct the full $\lambda$-dependence. 
Choosing $\lambda=-1,0,1$ we obtain
\begin{align}
A&=M_0\;,\; B=(M_1-M_{-1})/2\;,\; C=(M_1+M_{-1})/2-M_0\;.
\end{align}
In practice we used the representation 
\begin{align}
M_\lambda &=M_0\,(1-\lambda^2)+\frac{M_1}{2}\,(\lambda+\lambda^2) + \frac{M_{-1}}{2}\,(-\lambda+\lambda^2)\;
\end{align}
in order to get a more straightforward uncertainty estimate.

In fact, to any order in QCD,  we can separate the matrix element into a 
piece that depends only on the top quark Yukawa coupling $y_t$ (``box diagrams'') and a 
piece that depends on the Higgs boson trilinear self-coupling $\lambda$ (``triangle diagrams''):
\begin{align}
{\cal M} = y_t^2 {\cal M}_B + y_t \lambda {\cal M}_T.
\end{align}
The squared amplitude at each order can then be written as
\begin{align}
|{\cal M}|^2 = y_t^4 \left[ {\cal M}_B {\cal M}_B^* + \frac{\lambda}{y_t} ({\cal M}_B {\cal M}_T^* + {\cal M}_T {\cal M}_B^* ) +  \frac{\lambda^2}{y_t^2} {\cal M}_T {\cal M}_T^*  \right].\label{eq:yt}
\end{align}
The above parametrisation makes it clear that the dependence of the cross section on
both the Yukawa coupling and the Higgs boson self-coupling can be reconstructed
from only the 3 terms present in Eq.~(\ref{eq-amplambdadep}).
Of course this pattern changes once electroweak corrections are
included, which also have been calculated (partly) recently~\cite{Bizon:2018syu,Borowka:2018pxx}. 

In order to allow for comparisons and cross checks, we implemented
both the $m_t\to\infty$ limit as well as the  amplitudes with full $m_t$ dependence at
NLO. This allows to run the code in four different modes by changing
the flag {\tt mtdep} in the \powhegbox{} run card. The possible
choices are the following:
\begin{description}
 \item[{\tt mtdep=0}:]{computation using basic HEFT: all amplitudes
   are computed in the $m_t\to\infty$ limit.}
\item[{\tt mtdep=1}:]{computation using Born-improved HEFT. In this
   approximation the NLO part is computed in the $m_t\to\infty$ limit
   and reweighted pointwise in the phase-space by the ratio of the LO matrix
   element with full mass dependence to  the LO matrix
   element in HEFT.}
 \item[{\tt mtdep=2}:]{computation in the approximation \ftapprox. In
   this approximation the matrix elements for the Born and the real
   radiation contributions are computed with full top quark mass dependence, whereas the virtual part is
   computed as in the Born-improved HEFT. }
 \item[{\tt mtdep=3}:]{computation with full top quark mass dependence.}
\end{description}
Detailed instructions on how to run the code can be found in the
file {\tt manual-BOX-HH.pdf } in the folder {\tt ggHH/Docs} of the program.

When {\tt mtdep=3} is selected, the result of the virtual matrix element is based on a grid of pre-sampled phase-space points as described above. The phase-space points present in the grid are distributed such that they optimally sample the Standard Model (SM) Born matrix element. The same grid of points is used regardless of the value of $\lambda$ selected. Due to the finite number of points present in the grid, there is an associated statistical uncertainty which amounts to $0.1\%$ on the total cross section at $14\ \TeV$ for $\lambda=\lambda_\mathrm{SM}$. However, for $\lambda \neq \lambda_\mathrm{SM}$ the virtual matrix element can differ significantly in shape from the SM prediction, as is apparent from examining the $\mhh$ and $\pth$ distributions for different values of the Higgs boson self coupling. The uncertainty associated with the use of the grid is therefore larger for non-SM values of $\lambda$. The uncertainty increases as $\lambda$ is decreased below the SM value reaching $0.6\%$ on the total cross section at $14\ \TeV$ for $\chhh = -1$. Increasing $\lambda$ above the SM value, we obtain an uncertainty of $3\%$ on the total cross section at $14\ \TeV$ for $\chhh = 3$ and  $\chhh = 5$. Furthermore, for differential distributions the total uncertainty is not distributed uniformly in each bin but instead increases when the shape of the matrix element most differs from the SM prediction. Focusing on the invariant mass distribution, amongst the values of the Higgs boson self-coupling considered here, the largest uncertainty is obtained for the smallest values of $\mhh$ and $\chhh=3$. The uncertainty reaches $6\%$ for the lowest bin when a $40\ \GeV$ bin width is used.
